/**
 * @file config.h
 * @brief Файл конфигурации системы
 *
 * Этот файл содержит основные конфигурационные параметры системы:
 * - временные константы
 * - параметры ADC
 * - предельные значения
 * - определения состояний системы
 * - коды ошибок
 * - коэффициенты преобразования
 *
 * @author ordum
 * @date Oct 16, 2025
 */

#ifndef INC_CONFIG_H_
#define INC_CONFIG_H_

// ============================================
// Общие параметры системы
// ============================================

/** @brief Период выполнения цикла управления в миллисекундах */
#define CONTROL_DT_MS 1U

/** @brief Период переключения между CAN-шинами в миллисекундах */
#define CAN_TOGGLE_MS 250U

// ============================================
// Параметры ADC
// ============================================

/** @brief Количество каналов ADC для измерения */
#define ADC_CHANNEL_COUNT 5

// ============================================
// Коэффициенты преобразования ADC -> физические величины
// ============================================

/** @brief Разрешение ADC (12-bit = 4095) */
#define ADC_RESOLUTION 4095.0f

/** @brief Опорное напряжение ADC в вольтах */
#define VREF_VOLTS 3.3f

/** @brief Коэффициент преобразования ADC -> ток (А) */
#define ADC_TO_CURRENT_COEFF 0.80586f

/** @brief Коэффициент преобразования ADC -> напряжение (В) */
#define ADC_TO_VOLTAGE_COEFF 0.85959f

/** @brief Смещение нуля для измерения тока (А) */
#define CURRENT_OFFSET 1500.0f

/** @brief Смещение нуля для измерения напряжения (В) */
#define VOLTAGE_OFFSET 1600.0f

// ============================================
// Предельные значения для диагностики
// ============================================

/** @brief Минимальное допустимое напряжение шины (В) */
#define VBUS_MIN 0.0f

/** @brief Максимальное допустимое напряжение шины (В) */
#define VBUS_MAX 1500.0f

/** @brief Максимальный допустимый ток (А) */
#define I_MAX 1900.0f

// ============================================
// Параметры PWM
// ============================================

/** @brief Минимальное значение скважности PWM */
#define PWM_MIN_DUTY 0U

/**
 * @brief Максимальное значение скважности PWM
 * @param arr Значение регистра авто-перезагрузки таймера
 * @return Максимально допустимое значение заполнения
 */
#define PWM_MAX_DUTY(arr) (arr)

// ============================================
// Параметры CAN
// ============================================

/** @brief Период отправки CAN-сообщений в миллисекундах */
#define CAN_SEND_PERIOD_MS CAN_TOGGLE_MS

// ============================================
// Состояния системы
// ============================================

/**
 * @brief Перечисление состояний системы
 */
typedef enum {
    STATE_INIT = 0,      /**< Состояние инициализации */
    STATE_PRECHARGE = 1, /**< Состояние предзаряда */
    STATE_IDLE = 2,      /**< Холостой режим */
    STATE_CHARGE = 3,    /**< Режим заряда */
    STATE_DISCHARGE = 4  /**< Режим разряда */
} SystemState_t;

/**
 * @brief Перечисление состояний PWM
 */
typedef enum {
    STATE_DISABLE = 0,   /**< PWM отключен */
    STATE_ENABLE = 1     /**< PWM включен */
} PWMState_t;

// ============================================
// Коды ошибок (битовая маска)
// ============================================

/** @brief Отсутствие ошибок */
#define ERR_NONE 0x00

/** @brief Ошибка перенапряжения (бит 0) */
#define ERR_OVERVOLTAGE 0x01

/** @brief Ошибка пониженного напряжения (бит 1) */
#define ERR_UNDERVOLTAGE 0x02

/** @brief Ошибка перегрузки по току (бит 2) */
#define ERR_OVERCURRENT 0x04

/** @brief Ошибка драйвера IGBT (бит 3) */
#define ERR_IGBT_DRIVER 0x08

// ============================================
// Калибровочные коэффициенты (запасные)
// ============================================

/** @brief Калибровочный коэффициент тока 1 (А) */
#define CURR_CAL1 0.0f

/** @brief Калибровочный коэффициент тока 2 (А) */
#define CURR_CAL2 0.0f

/** @brief Калибровочный коэффициент тока 3 (А) */
#define CURR_CAL3 0.0f

/** @brief Калибровочный коэффициент напряжения 1 (В) */
#define VOL_CAL1 0.0f

/** @brief Калибровочный коэффициент напряжения 2 (В) */
#define VOL_CAL2 0.0f

// ============================================
// Вспомогательные определения
// ============================================

/**
 * @brief Прототип функции вывода символа
 * @param ch Символ для вывода
 * @return Выведенный символ
 * @note Используется для перенаправления printf
 */
#define PUTCHAR_PROTOTYPE int __io_putchar(int ch)




#endif /* INC_CONFIG_H_ */
