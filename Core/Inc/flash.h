/**
 * @file flash.h
 * @brief Заголовочный файл модуля работы с FLASH памятью
 *
 * Этот файл содержит объявления функций и структур для работы
 * с FLASH памятью микроконтроллера для хранения калибровочных данных.
 */

#ifndef INC_FLASH_H_
#define INC_FLASH_H_

#include <stdint.h>
#include "stm32g4xx_hal.h"

/** @brief Начальный адрес пользовательской области FLASH */
#define FLASH_USER_START_ADDR  0x0801F800U

/** @brief Конечный адрес пользовательской области FLASH */
#define FLASH_USER_END_ADDR    0x0801FFFFU

/**
 * @brief Структура калибровочных данных, хранящихся во FLASH
 *
 * Содержит калибровочные коэффициенты для всех измерительных каналов.
 */
typedef struct
{
    uint32_t calCur1; /**< Калибровочное смещение для тока 1 (входной ток) */
    uint32_t calCur2; /**< Калибровочное смещение для тока 2 (выходной ток) */
    int16_t  calCur3; /**< Калибровочное смещение для тока 3 (ток дросселя) */
    int16_t  calVol1; /**< Калибровочное смещение для напряжения 1 (входное) */
    uint16_t calVol2; /**< Калибровочное смещение для напряжения 2 (выходное) */
    uint16_t calPerf; /**< Резерв для хранения показателя производительности */
} FlashVars_t;

/**
 * @brief Стирание пользовательской области FLASH
 *
 * Выполняет стирание страницы FLASH, выделенной для хранения
 * калибровочных данных.
 *
 * @return Статус операции
 * @retval HAL_OK Операция выполнена успешно
 * @retval HAL_ERROR Произошла ошибка при стирании
 *
 * @note Функция отключает прерывания на время операции
 * @warning Стирает всю страницу FLASH (2 КБ для STM32G4)
 */
HAL_StatusTypeDef Flash_Erase(void);

/**
 * @brief Запись калибровочных данных во FLASH
 *
 * Записывает структуру с калибровочными данными во FLASH память
 * по выровненному адресу.
 *
 * @param vars Указатель на структуру с калибровочными данными
 * @return Статус операции
 * @retval HAL_OK Операция выполнена успешно
 * @retval HAL_ERROR Произошла ошибка при записи
 *
 * @note Функция отключает прерывания на время операции
 * @note Данные выравниваются на границу 8 байт
 * @warning Перед записью необходимо выполнить стирание сектора
 */
HAL_StatusTypeDef Flash_WriteVars(const FlashVars_t *vars);

/**
 * @brief Чтение калибровочных данных из FLASH
 *
 * Считывает структуру с калибровочными данными из FLASH памяти.
 *
 * @param vars Указатель на структуру для сохранения считанных данных
 *
 * @note Функция не проверяет целостность данных
 * @note Для проверки корректности данных рекомендуется использовать CRC
 */
void Flash_ReadVars(FlashVars_t *vars);

#endif /* INC_FLASH_H_ */
