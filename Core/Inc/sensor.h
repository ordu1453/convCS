/**
 * @file sensor.h
 * @brief Заголовочный файл модуля работы с датчиками
 *
 * Этот файл содержит объявления функций для работы с аналоговыми датчиками,
 * включая инициализацию, чтение данных, калибровку и получение текущих значений.
 *
 * @author ordum
 * @date Oct 16, 2025
 */

#ifndef INC_SENSOR_H_
#define INC_SENSOR_H_

#include "main.h"
#include "types.h"

/**
 * @brief Инициализация модуля датчиков
 *
 * Выполняет начальную настройку модуля:
 * - Чтение калибровочных данных из FLASH памяти
 * - Инициализацию фильтров Калмана для всех каналов измерения
 *
 * @note Должна быть вызвана один раз при старте системы
 */
void sensorInit(void);

/**
 * @brief Чтение и обработка данных с датчиков
 *
 * Выполняет последовательное чтение всех 5 каналов ADC:
 * - Входное напряжение
 * - Выходное напряжение
 * - Входной ток
 * - Выходной ток
 * - Ток дросселя
 *
 * Данные преобразуются в физические величины, корректируются
 * калибровочными коэффициентами и фильтруются через фильтры Калмана.
 *
 * @note Функция блокирующая, время выполнения зависит от скорости ADC
 */
void sensorRead(void);

/**
 * @brief Получение текущих значений датчиков
 *
 * Возвращает указатель на структуру с текущими отфильтрованными значениями
 * всех датчиков.
 *
 * @return Указатель на константную структуру SensorValues_t с текущими значениями
 * @retval Указатель на структуру, содержащую:
 *         - voltageIn: Входное напряжение (В)
 *         - voltageOut: Выходное напряжение (В)
 *         - currentIn: Входной ток (А)
 *         - currentOut: Выходной ток (А)
 *         - currentChoke: Ток дросселя (А)
 *
 * @note Структура обновляется при каждом вызове sensorRead()
 * @warning Не изменяйте возвращаемую структуру, она предназначена только для чтения
 */
const SensorValues_t* sensorGetValues(void);

/**
 * @brief Процедура калибровки датчиков
 *
 * Выполняет автоматическую калибровку всех датчиков системы:
 * - Накопление 1000 измерений для каждого канала
 * - Вычисление средних значений смещений (offsets)
 * - Сохранение калибровочных коэффициентов во FLASH память
 *
 * @warning Функция выполняет стирание и запись FLASH памяти
 * @note Калибровка должна выполняться при нулевых входных сигналах
 * @note В режиме DEBUG выводит информацию об ошибках через UART
 */
void SensorCalibration(void);

/**
 * @brief Запуск процедуры вычисления калибровочных коэффициентов
 *
 * Обертка для процедуры калибровки с отключением прерываний на время выполнения.
 * Обеспечивает атомарность операции калибровки.
 *
 * @warning Отключает все прерывания на время выполнения калибровки
 * @note Рекомендуется вызывать при нажатии кнопки калибровки
 */
void sensorCalculateCoeff(void);

#endif /* INC_SENSOR_H_ */
