/**
 * @file pid.h
 * @brief Заголовочный файл модуля ПИ-регуляторов
 *
 * Этот файл содержит объявления структур и функций для работы
 * с пропорционально-интегральными регуляторами.
 *
 * @author ordum
 * @date Oct 16, 2025
 */

#ifndef INC_PID_H_
#define INC_PID_H_

#include <stdint.h>
#include "main.h"
#include "config.h"

// -------------------------------
// Структура одного ПИ-регулятора
// -------------------------------

/**
 * @brief Структура одиночного ПИ-регулятора
 *
 * Содержит параметры и состояние дискретного ПИ-регулятора.
 * Формула: u(t) = Kp * e(t) + Ki * ∫e(t)dt
 */
typedef struct {
    float kp;               /**< Пропорциональный коэффициент */
    float ki;               /**< Интегральный коэффициент */
    float dt;               /**< Временной шаг дискретизации (с) */
    float integral;         /**< Текущее значение интегратора */
    float outMin;           /**< Минимальное значение выхода */
    float outMax;           /**< Максимальное значение выхода */
    unsigned int output;    /**< Текущее выходное значение */
} PIController_t;

/*
 *
 *           ┌────────────────────────────────────┐
 *           │            ПИ-РЕГУЛЯТОР            │
 *           └────────────────────────────────────┘
 *
 *                     ┌─────────────┐
 *   r(t) ─►( + )─────►│   e(t)      │───────────┐
 *           ▲         └─────────────┘           │
 *           │                                   ▼
 *           │                           ┌─────────────────┐
 *           │                           │  Kp + Ki * ∫e(t)│
 *           │                           └─────────────────┘
 *           │                                    │
 *           │                                    ▼
 *           │                                 ┌──────┐
 *           └─────────────────────────────────┤ y(t) │
 *                                             └──────┘
 *
 * Структурная схема ПИ-регулятора
 */

// -------------------------------
// Структура составного регулятора
// -------------------------------

/**
 * @brief Структура каскадного (двухконтурного) ПИ-регулятора
 *
 * Содержит два ПИ-регулятора в каскадной структуре:
 * - Внешний контур: регулирование напряжения (медленный)
 * - Внутренний контур: регулирование тока (быстрый)
 */
typedef struct {
    PIController_t voltageLoop;  /**< Внешний контур — напряжение */
    PIController_t currentLoop;  /**< Внутренний контур — ток */
} PI2Controller_t;

/*
 *               ╔════════════════════════════════════╗
 *               ║          КАСАДНЫЙ ДВА ПИ           ║
 *               ╚════════════════════════════════════╝
 *
 *       r(t) ───► (+) ───► e1(t) ───►┌────────────────────────┐
 *                 │                  │u1(t) = Kp1*e1 + Ki1∫e1 │
 *                 │                  └────────────────────────┘
 *                 │                            │
 *                 │                            ▼
 *                 │                        ┌────────┐
 *                 │                        │ y1(t)  │
 *                 │                        └────────┘
 *                 │                            │
 *                 │           ┌────────────────┘
 *                 │           ▼
 *                 │       (+) ───► e2(t) ───►┌────────────────────────┐
 *                 │       │                  │u2(t) = Kp2*e2 + Ki2∫e2 │
 *                 │       │                  └────────────────────────┘
 *                 │       │                            │
 *                 │       │                            ▼
 *                 │       │                         ┌────────┐
 *                 └───────┴────────────────────────►│ y2(t)  │
 *                                                   └────────┘
 *
 * Структурная схема каскадного ПИ-регулятора
 */

// -------------------------------
// Функции одиночного ПИ-регулятора
// -------------------------------

/**
 * @brief Инициализация одиночного ПИ-регулятора
 */
void piInit(PIController_t* pi, float kp, float ki, float dt, float outMin, float outMax);

/**
 * @brief Обновление одиночного ПИ-регулятора
 */
unsigned int piUpdate(PIController_t* pi, float setpoint, float measurement);

/**
 * @brief Сброс одиночного ПИ-регулятора
 */
void piReset(PIController_t* pi);

// -------------------------------
// Функции составного ПИ-регулятора
// -------------------------------

/**
 * @brief Инициализация каскадного ПИ-регулятора
 */
void pi2Init(PI2Controller_t* pi2,
             float kp_v, float ki_v,
             float kp_i, float ki_i,
             float dt, float inMin, float inMax,
             float outMin, float outMax);

/**
 * @brief Обновление каскадного ПИ-регулятора
 */
unsigned int pi2Update(PI2Controller_t* pi2,
                float voltageSet, float voltageMeas,
                float currentMeas);

/**
 * @brief Сброс каскадного ПИ-регулятора
 */
void pi2Reset(PI2Controller_t* pi2);

#endif /* INC_PID_H_ */
